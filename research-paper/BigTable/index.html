<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bigtable Interactive Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; }
        
        /* Animation Classes */
        .packet {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            z-index: 50;
            transition: all 0.5s ease-in-out;
            pointer-events: none;
        }

        .highlight-row {
            animation: highlight 1s ease-out;
        }

        @keyframes highlight {
            0% { background-color: #fef08a; }
            100% { background-color: transparent; }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .node-container {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold"><i class="fas fa-database mr-2"></i>Bigtable Interactive</h1>
                <p class="text-blue-100 text-sm">Distributed Storage Simulation</p>
            </div>
            <div class="text-xs bg-blue-700 px-3 py-1 rounded">
                v1.0 | Single Page Simulation
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow flex flex-col lg:flex-row gap-6">

        <!-- Left Column: Controls & Narrative -->
        <div class="w-full lg:w-1/3 flex flex-col gap-6">
            
            <!-- Part 1: Data Model Playground -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <h2 class="text-xl font-bold text-slate-700 mb-4 border-b pb-2">1. Data Model & Sorting</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase">Input URL (Row Key)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="urlInput" placeholder="maps.google.com" class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value="maps.google.com">
                            <button onclick="addData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition font-medium">Insert</button>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">Try: <code>mail.google.com</code> or <code>news.google.com</code></p>
                    </div>
                    
                    <div class="bg-slate-100 p-3 rounded text-xs font-mono border border-slate-200 h-32 overflow-y-auto" id="sortedList">
                        <!-- Dynamic List Items -->
                        <div class="text-slate-400 italic text-center mt-8">Empty Table</div>
                    </div>
                    <div class="text-xs text-slate-500">
                        <i class="fas fa-info-circle mr-1"></i> Note how keys are reversed (com.google.maps) and lexicographically sorted.
                    </div>
                </div>
            </div>

            <!-- Simulation Controls -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 flex-grow">
                <h2 class="text-xl font-bold text-slate-700 mb-4 border-b pb-2">Simulation Controls</h2>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="simulateWrite()" id="btn-write" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded flex flex-col items-center justify-center transition group">
                        <i class="fas fa-pen mb-1 group-hover:scale-110 transition"></i>
                        <span class="text-sm font-bold">Write Request</span>
                    </button>
                    
                    <button onclick="simulateRead()" id="btn-read" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded flex flex-col items-center justify-center transition group">
                        <i class="fas fa-search mb-1 group-hover:scale-110 transition"></i>
                        <span class="text-sm font-bold">Read Request</span>
                    </button>

                    <button onclick="forceCompaction()" id="btn-compact" class="bg-amber-600 hover:bg-amber-700 text-white p-3 rounded flex flex-col items-center justify-center transition group">
                        <i class="fas fa-compress-alt mb-1 group-hover:scale-110 transition"></i>
                        <span class="text-sm font-bold">Force Major Compact</span>
                    </button>

                    <button onclick="killServer()" id="btn-kill" class="bg-red-600 hover:bg-red-700 text-white p-3 rounded flex flex-col items-center justify-center transition group">
                        <i class="fas fa-skull mb-1 group-hover:scale-110 transition"></i>
                        <span class="text-sm font-bold">Kill Server</span>
                    </button>
                </div>

                <!-- Event Log -->
                <div class="bg-slate-900 text-green-400 p-4 rounded font-mono text-xs h-48 overflow-y-auto shadow-inner" id="consoleLog">
                    <div>> System initialized...</div>
                    <div>> Waiting for operations...</div>
                </div>
            </div>
        </div>

        <!-- Right Column: System Architecture Visualization -->
        <div class="w-full lg:w-2/3 bg-white p-6 rounded-xl shadow-md border border-slate-200 relative overflow-hidden" id="architecture-stage">
            <h2 class="text-xl font-bold text-slate-700 mb-6 border-b pb-2">System Architecture</h2>
            
            <!-- Nodes Layout -->
            <div class="relative h-[600px] w-full select-none">
                
                <!-- Client -->
                <div id="node-client" class="absolute top-10 left-10 w-24 flex flex-col items-center node-container z-20">
                    <div class="w-16 h-16 bg-blue-100 border-2 border-blue-500 rounded-full flex items-center justify-center shadow-md">
                        <i class="fas fa-user text-2xl text-blue-600"></i>
                    </div>
                    <span class="mt-2 font-bold text-sm">Client</span>
                </div>

                <!-- Chubby (Metadata) -->
                <div id="node-chubby" class="absolute top-10 left-1/2 transform -translate-x-1/2 w-24 flex flex-col items-center node-container z-20">
                    <div class="w-14 h-14 bg-yellow-100 border-2 border-yellow-500 rounded-lg flex items-center justify-center shadow-md">
                        <i class="fas fa-map-signs text-xl text-yellow-600"></i>
                    </div>
                    <span class="mt-2 font-bold text-xs">Chubby (Lock/Meta)</span>
                </div>

                <!-- Master -->
                <div id="node-master" class="absolute top-10 right-10 w-24 flex flex-col items-center node-container z-20">
                    <div class="w-16 h-16 bg-purple-100 border-2 border-purple-500 rounded-full flex items-center justify-center shadow-md">
                        <i class="fas fa-crown text-2xl text-purple-600"></i>
                    </div>
                    <span class="mt-2 font-bold text-sm">Master</span>
                </div>

                <!-- Tablet Server Container -->
                <div id="node-server" class="absolute top-40 left-1/2 transform -translate-x-1/2 w-80 p-4 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 transition-all z-10">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-slate-700"><i class="fas fa-server mr-2"></i>Tablet Server</span>
                        <div id="server-status" class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    </div>

                    <!-- Bloom Filter -->
                    <div id="node-bloom" class="w-full bg-pink-100 border border-pink-300 p-2 rounded mb-2 text-center text-xs text-pink-700 font-semibold opacity-50 transition-opacity">
                        <i class="fas fa-filter mr-1"></i> Bloom Filter
                    </div>

                    <!-- Memtable (RAM) -->
                    <div class="w-full bg-white border border-slate-300 p-3 rounded shadow-sm relative overflow-hidden">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-semibold">Memtable (RAM)</span>
                            <span id="memtable-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 h-4 rounded-full overflow-hidden">
                            <div id="memtable-bar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
                        </div>
                        <!-- Memtable Items Visualization -->
                        <div id="memtable-items" class="mt-2 h-16 overflow-y-auto text-[10px] font-mono text-slate-500">
                            <!-- Items appear here -->
                        </div>
                    </div>
                </div>

                <!-- GFS / Disk Layer -->
                <div class="absolute bottom-10 left-0 w-full px-10">
                    <div class="border-t-4 border-slate-300 pt-4 relative">
                        <span class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-white px-2 text-xs font-bold text-slate-400">GFS / COLOSSUS (PERSISTENT DISK)</span>
                        
                        <div class="flex gap-8 justify-center">
                            
                            <!-- Commit Log -->
                            <div id="node-log" class="w-32 bg-slate-800 text-green-400 p-2 rounded-lg text-xs font-mono h-32 overflow-hidden shadow-lg border-2 border-slate-600">
                                <div class="border-b border-slate-600 pb-1 mb-1 font-bold text-center text-white">Commit Log (WAL)</div>
                                <div id="log-content" class="flex flex-col gap-1 opacity-80"></div>
                            </div>

                            <!-- SSTables -->
                            <div id="node-sstable-container" class="flex-1 bg-slate-100 border-2 border-slate-300 rounded-lg p-2 h-32 flex items-end justify-center gap-2 overflow-x-auto relative">
                                <div class="absolute top-2 left-2 text-xs font-bold text-slate-400">SSTables (Immutable)</div>
                                <!-- SSTables will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Overlay Message -->
            <div id="overlay-msg" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-4 rounded-lg hidden z-50 text-center backdrop-blur-sm">
                <i class="fas fa-info-circle text-3xl mb-2 text-blue-400"></i>
                <h3 id="overlay-title" class="font-bold text-lg">Title</h3>
                <p id="overlay-text" class="text-sm">Message</p>
            </div>

        </div>

    </main>

    <script>
        // --- State Management ---
        const state = {
            memtable: [],
            sstables: [], // Array of arrays
            commitLog: [],
            memtableCapacity: 5,
            isServerUp: true,
            rows: [
                { key: "com.google.mail", col: "contents:html" },
                { key: "com.google.news", col: "contents:html" }
            ]
        };

        // --- DOM Elements ---
        const el = {
            console: document.getElementById('consoleLog'),
            memtableBar: document.getElementById('memtable-bar'),
            memtablePercent: document.getElementById('memtable-percent'),
            memtableItems: document.getElementById('memtable-items'),
            logContent: document.getElementById('log-content'),
            sstableContainer: document.getElementById('node-sstable-container'),
            sortedList: document.getElementById('sortedList'),
            serverNode: document.getElementById('node-server'),
            serverStatus: document.getElementById('server-status'),
            urlInput: document.getElementById('urlInput'),
            overlay: document.getElementById('overlay-msg'),
            overlayTitle: document.getElementById('overlay-title'),
            overlayText: document.getElementById('overlay-text'),
            bloom: document.getElementById('node-bloom')
        };

        // --- Initialization ---
        function init() {
            renderList();
        }

        // --- Part 1: Data Model Logic ---
        function reverseDomain(url) {
            const parts = url.split('.');
            if (parts.length > 1) {
                return parts.reverse().join('.');
            }
            return url;
        }

        function addData() {
            const rawUrl = el.urlInput.value.trim();
            if (!rawUrl) return;

            const rowKey = reverseDomain(rawUrl);
            
            // Check if exists
            if (!state.rows.find(r => r.key === rowKey)) {
                state.rows.push({ key: rowKey, col: "contents:html" });
                // Lexicographical Sort
                state.rows.sort((a, b) => a.key.localeCompare(b.key));
                
                renderList();
                
                // Highlight the new item
                setTimeout(() => {
                    const items = document.querySelectorAll('.list-item');
                    items.forEach(item => {
                        if (item.innerText.includes(rowKey)) {
                            item.classList.add('highlight-row', 'bg-yellow-100');
                        }
                    });
                }, 100);

                log(`Data Model: Inserted '${rawUrl}' as '${rowKey}'`);
            } else {
                log(`Data Model: Key '${rowKey}' already exists.`);
            }
        }

        function renderList() {
            el.sortedList.innerHTML = '';
            state.rows.forEach(row => {
                const div = document.createElement('div');
                div.className = "list-item p-1 border-b border-slate-200 last:border-0 hover:bg-slate-50 transition";
                div.innerHTML = `<span class="font-bold text-blue-600">${row.key}</span> <span class="text-slate-400 text-[10px] ml-2">(${row.col})</span>`;
                el.sortedList.appendChild(div);
            });
        }

        // --- Animation Helpers ---
        function createPacket(startId, endId, color = 'bg-blue-500', duration = 1000) {
            return new Promise(resolve => {
                const startNode = document.getElementById(startId).getBoundingClientRect();
                const endNode = document.getElementById(endId).getBoundingClientRect();
                const stage = document.getElementById('architecture-stage').getBoundingClientRect();

                const packet = document.createElement('div');
                packet.className = `packet ${color}`;
                
                // Adjust for relative positioning within the stage
                const startX = startNode.left - stage.left + startNode.width / 2;
                const startY = startNode.top - stage.top + startNode.height / 2;
                const endX = endNode.left - stage.left + endNode.width / 2;
                const endY = endNode.top - stage.top + endNode.height / 2;

                packet.style.left = `${startX}px`;
                packet.style.top = `${startY}px`;

                document.getElementById('architecture-stage').appendChild(packet);

                // Trigger reflow
                packet.offsetHeight;

                packet.style.left = `${endX}px`;
                packet.style.top = `${endY}px`;
                packet.style.transition = `all ${duration}ms ease-in-out`;

                setTimeout(() => {
                    packet.remove();
                    resolve();
                }, duration);
            });
        }

        function showOverlay(title, text, duration = 2000) {
            el.overlayTitle.innerText = title;
            el.overlayText.innerText = text;
            el.overlay.classList.remove('hidden');
            setTimeout(() => {
                el.overlay.classList.add('hidden');
            }, duration);
        }

        function log(msg) {
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            el.console.appendChild(div);
            el.console.scrollTop = el.console.scrollHeight;
        }

        // --- Part 2: Write Path Logic ---
        async function simulateWrite() {
            if (!state.isServerUp) {
                log("ERROR: Tablet Server is DOWN. Write failed.");
                el.serverNode.classList.add('shake');
                setTimeout(() => el.serverNode.classList.remove('shake'), 500);
                return;
            }

            const key = `k${Math.floor(Math.random() * 1000)}`;
            log(`Client: Initiating Write for key '${key}'...`);

            // Step 1: Client -> Chubby (Metadata)
            await createPacket('node-client', 'node-chubby', 'bg-blue-500', 600);
            log("Client: Checked Chubby for Tablet location.");

            // Step 2: Client -> Server
            await createPacket('node-client', 'node-server', 'bg-blue-500', 800);
            
            // Step 3: Server -> Commit Log (WAL)
            await createPacket('node-server', 'node-log', 'bg-green-500', 500);
            
            // Update Log UI
            const logEntry = document.createElement('div');
            logEntry.className = "text-[10px] border-b border-slate-700";
            logEntry.innerText = `WRITE: ${key}`;
            el.logContent.prepend(logEntry);
            log("Server: Written to Commit Log (WAL) for durability.");

            // Step 4: Add to Memtable
            if (state.memtable.length < state.memtableCapacity) {
                state.memtable.push(key);
                state.memtable.sort(); // Keep Memtable sorted
                updateMemtableUI();
                log(`Server: Added '${key}' to Memtable (RAM).`);
            } else {
                // Should not happen if we handle flush immediately, but just in case
                log("Server: Memtable Full! Triggering immediate compaction.");
                await performMinorCompaction();
                state.memtable.push(key);
                updateMemtableUI();
            }

            // Step 5: Ack
            await createPacket('node-server', 'node-client', 'bg-green-400', 600);
            log("Client: Write Acknowledged (Success).");

            // Auto-trigger Minor Compaction if full
            if (state.memtable.length >= state.memtableCapacity) {
                setTimeout(performMinorCompaction, 1000);
            }
        }

        function updateMemtableUI() {
            const percent = (state.memtable.length / state.memtableCapacity) * 100;
            el.memtableBar.style.width = `${percent}%`;
            el.memtablePercent.innerText = `${Math.round(percent)}%`;
            
            if (percent >= 100) el.memtableBar.classList.replace('bg-blue-500', 'bg-red-500');
            else el.memtableBar.classList.replace('bg-red-500', 'bg-blue-500');

            el.memtableItems.innerHTML = state.memtable.map(k => `<div>${k}</div>`).join('');
        }

        // --- Part 3: Compactions ---
        async function performMinorCompaction() {
            log("System: Triggering MINOR COMPACTION (Memtable -> SSTable)...");
            
            // Visual Freeze
            el.memtableBar.classList.add('bg-blue-300');
            
            // Animation: Memtable -> SSTable
            await createPacket('node-server', 'node-sstable-container', 'bg-red-500', 1000);

            // Create SSTable UI
            createSSTableUI(state.memtable.length); // Visual size based on count

            // Reset Memtable
            state.sstables.push([...state.memtable]); // Copy data to disk
            state.memtable = [];
            state.commitLog = []; // Log can be truncated now
            el.logContent.innerHTML = '<div class="text-slate-500 italic text-[10px]">Log Truncated</div>';
            
            updateMemtableUI();
            el.memtableBar.classList.remove('bg-blue-300');
            log("System: Minor Compaction Complete. Memtable flushed.");
        }

        function createSSTableUI(size) {
            const div = document.createElement('div');
            // Random height between 40px and 80px to show variance
            const height = 40 + (size * 5); 
            div.className = "w-12 bg-slate-400 border border-slate-500 rounded-t shadow-md hover:bg-slate-500 transition cursor-pointer flex items-center justify-center text-xs text-white sstable-file";
            div.style.height = `${height}px`;
            div.innerText = `SST`;
            div.title = "Immutable Sorted String Table";
            el.sstableContainer.appendChild(div);
        }

        async function forceCompaction() {
            if (state.sstables.length < 2) {
                log("System: Not enough SSTables to compact (Need 2+).");
                return;
            }

            log("System: Starting MAJOR COMPACTION...");
            
            // Animation: Merge files
            const files = document.querySelectorAll('.sstable-file');
            files.forEach(f => {
                f.style.transform = "scale(0.1)";
                f.style.opacity = "0";
            });

            await new Promise(r => setTimeout(r, 500));
            el.sstableContainer.innerHTML = ''; // Clear old files

            // Create one big file
            const totalSize = state.sstables.reduce((acc, curr) => acc + curr.length, 0);
            const bigDiv = document.createElement('div');
            bigDiv.className = "w-20 bg-amber-600 border border-amber-700 rounded-t shadow-lg flex items-center justify-center text-xs text-white font-bold animate-pulse";
            bigDiv.style.height = "100px";
            bigDiv.innerText = "MERGED";
            el.sstableContainer.appendChild(bigDiv);

            // Logic reset
            state.sstables = [["merged_data"]];
            
            log(`System: Major Compaction Complete. Merged ${files.length} files into 1.`);
            setTimeout(() => bigDiv.classList.remove('animate-pulse'), 1000);
        }

        // --- Part 4: Read Path ---
        async function simulateRead() {
             if (!state.isServerUp) {
                log("ERROR: Server DOWN. Read failed.");
                return;
            }

            const searchKey = prompt("Enter key to search (e.g., k10):", "k10");
            if (!searchKey) return;

            log(`Client: Reading '${searchKey}'...`);

            // 1. Permission
            await createPacket('node-client', 'node-server', 'bg-indigo-500', 800);

            // 2. Bloom Filter Check
            el.bloom.classList.remove('opacity-50');
            el.bloom.classList.add('bg-pink-300', 'scale-105');
            log("Server: Checking Bloom Filter...");
            await new Promise(r => setTimeout(r, 600));
            
            // Simulate Bloom Filter Logic (Simple probability for demo)
            const inMem = state.memtable.includes(searchKey);
            // Flatten sstables to check existence
            const inDisk = state.sstables.flat().includes(searchKey);
            const exists = inMem || inDisk;

            el.bloom.classList.remove('bg-pink-300', 'scale-105');
            el.bloom.classList.add('opacity-50');

            if (!exists) {
                // Scenario A: Bloom says No
                log("Bloom Filter: Definitely NOT present. Returning 'Not Found'.");
                showOverlay("Not Found", `Key ${searchKey} does not exist.`, 1500);
                await createPacket('node-server', 'node-client', 'bg-red-500', 600);
                return;
            }

            // Scenario B: Bloom says Maybe -> Check Memtable & Disk
            log("Bloom Filter: Maybe present. Checking Memtable & SSTables...");
            
            // Animation Scan
            el.memtableBar.classList.add('bg-yellow-400'); // Scanning Memtable
            const files = document.querySelectorAll('.sstable-file');
            files.forEach(f => f.classList.add('bg-yellow-400')); // Scanning Disk

            await new Promise(r => setTimeout(r, 1000));

            // Reset visuals
            el.memtableBar.classList.remove('bg-yellow-400');
            files.forEach(f => f.classList.remove('bg-yellow-400'));

            // Merge & Return
            log(`Server: Found in ${inMem ? 'Memtable' : 'SSTable'}. Merging & Returning.`);
            await createPacket('node-server', 'node-client', 'bg-green-400', 600);
            showOverlay("Data Found", `Read value for ${searchKey}`, 2000);
        }

        // --- Part 5: Failure & Recovery ---
        async function killServer() {
            if (!state.isServerUp) {
                log("Server is already down.");
                return;
            }

            state.isServerUp = false;
            log("EVENT: TABLET SERVER FAILED!");
            
            // Visual Failure
            el.serverNode.style.opacity = "0.3";
            el.serverNode.style.filter = "grayscale(100%)";
            el.serverStatus.classList.remove('bg-green-500', 'animate-pulse');
            el.serverStatus.classList.add('bg-red-600');

            // Wait for Master detection
            setTimeout(async () => {
                log("Master: Detected server failure (Chubby lock expired).");
                await createPacket('node-master', 'node-server', 'bg-purple-500', 1000);
                
                recoverServer();
            }, 1500);
        }

        async function recoverServer() {
            log("Master: Assigning new Tablet Server...");
            
            // Visual Recovery
            el.serverNode.style.opacity = "1";
            el.serverNode.style.filter = "none";
            el.serverStatus.classList.remove('bg-red-600');
            el.serverStatus.classList.add('bg-yellow-500'); // Starting up

            log("New Server: Replaying Commit Log (WAL)...");
            
            // Animation: Log -> Server
            await createPacket('node-log', 'node-server', 'bg-green-500', 1000);

            // Restore Memtable from "Log" (Simulation)
            // In a real simulation we'd parse the log. Here we just assume the log allows us to restore the state.
            // (Note: state.memtable wasn't actually cleared on kill in this JS model, but conceptually it was lost from RAM)
            
            el.serverStatus.classList.remove('bg-yellow-500');
            el.serverStatus.classList.add('bg-green-500', 'animate-pulse');
            state.isServerUp = true;
            
            log("Recovery Complete: Server Online. No data lost.");
            showOverlay("Recovery Success", "Memtable rebuilt from WAL.", 2000);
        }

        // Run Init
        init();

    </script>
</body>
</html>
