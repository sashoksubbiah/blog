<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROOT // DIRECTORY</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: JetBrains Mono (Nerdy) & Inter (UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                        sans: ['"Inter"', 'sans-serif'],
                    },
                    colors: {
                        term: {
                            bg: '#09090b',       /* Zinc 950 */
                            card: 'rgba(24, 24, 27, 0.6)', /* Zinc 900 / 60% */
                            border: 'rgba(63, 63, 70, 0.4)', /* Zinc 700 / 40% */
                            accent: '#22d3ee',   /* Cyan 400 */
                            dim: '#a1a1aa',      /* Zinc 400 */
                            success: '#4ade80',  /* Green 400 */
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            background-image: 
                radial-gradient(at 0% 0%, rgba(34, 211, 238, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.05) 0px, transparent 50%);
            color: #e4e4e7;
            overflow-x: hidden;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(10, 10, 12, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            border-color: rgba(34, 211, 238, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(34, 211, 238, 0.1);
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
        }

        /* Scanline Effect */
        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(34, 211, 238, 0.1);
            opacity: 0.4;
            animation: scan 6s linear infinite;
            pointer-events: none;
            z-index: 50;
        }

        @keyframes scan {
            0% { top: -10%; }
            100% { top: 110%; }
        }

        /* Iframe Container */
        .preview-container {
            transition: opacity 0.3s ease;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #22d3ee; }
    </style>
</head>
<body class="font-sans antialiased h-screen flex flex-col overflow-hidden selection:bg-term-accent selection:text-black">

    <div class="scanline"></div>

    <!-- Header / HUD -->
    <header class="h-16 flex-none glass z-40 px-6 flex items-center justify-between border-b border-white/10">
        <div class="flex items-center space-x-4">
            <div class="w-8 h-8 rounded bg-term-accent/10 flex items-center justify-center border border-term-accent/20">
                <i class="fa-solid fa-terminal text-term-accent text-sm"></i>
            </div>
            <div class="flex flex-col">
                <h1 class="font-mono font-bold text-sm tracking-widest text-white leading-none">SYS.ROOT_DIR</h1>
                <span class="text-[10px] text-term-dim uppercase mt-1" id="repo-label">Connecting...</span>
            </div>
        </div>

        <!-- Breadcrumbs -->
        <div class="hidden md:flex items-center px-4 py-1.5 rounded-full bg-white/5 border border-white/5 font-mono text-xs text-term-dim space-x-2" id="breadcrumb-container">
            <span class="text-term-accent hover:text-white cursor-pointer transition-colors" onclick="resetToRoot()">~/</span>
        </div>

        <div class="flex items-center space-x-4 text-xs font-mono">
            <div class="flex items-center text-term-success">
                <span class="w-2 h-2 rounded-full bg-term-success mr-2 animate-pulse"></span>
                ONLINE
            </div>
            <a href="#" id="github-link" target="_blank" class="hover:text-term-accent transition-colors"><i class="fa-brands fa-github text-lg"></i></a>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 flex relative overflow-hidden">
        
        <!-- File Grid Area -->
        <section class="flex-1 p-6 md:p-10 overflow-y-auto relative z-10" id="main-view">
            
            <!-- Loading State -->
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-[#050505] z-20 hidden">
                <div class="flex flex-col items-center">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-term-accent mb-4"></i>
                    <span class="font-mono text-xs text-term-dim animate-pulse">FETCHING DATA STREAMS...</span>
                </div>
            </div>

            <!-- Empty State / Error -->
            <div id="error-msg" class="hidden flex flex-col items-center justify-center h-full text-term-dim">
                <i class="fa-solid fa-triangle-exclamation text-3xl mb-4 text-red-500"></i>
                <p class="font-mono text-sm" id="error-text">Connection Failed</p>
                <button onclick="window.location.reload()" class="mt-4 px-4 py-2 border border-white/10 hover:bg-white/5 rounded text-xs">RETRY</button>
            </div>

            <!-- Dynamic Grid -->
            <!-- The class here is set dynamically by JS based on view mode (Grid vs List) -->
            <div id="file-grid">
                <!-- JS Injects content here -->
            </div>

        </section>

        <!-- Preview Overlay (Iframe) -->
        <div id="preview-overlay" class="absolute inset-0 bg-[#050505] z-30 transform translate-y-full transition-transform duration-500 flex flex-col">
            
            <!-- Floating Controls (Absolute, transparent) -->
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start pointer-events-none z-50">
                <!-- Title Pill -->
                <div class="pointer-events-auto glass px-3 py-1.5 rounded-full flex items-center space-x-2 border border-white/10 bg-black/50 backdrop-blur-md shadow-lg">
                     <span class="w-2 h-2 rounded-full bg-term-success animate-pulse"></span>
                     <span class="font-mono text-[10px] text-white tracking-widest uppercase" id="preview-title">PREVIEW_MODE</span>
                </div>

                <!-- Action Pills -->
                <div class="flex space-x-2 pointer-events-auto">
                    <a id="preview-external-link" href="#" target="_blank" class="glass w-9 h-9 rounded-full flex items-center justify-center text-term-dim hover:text-term-accent hover:border-term-accent/50 transition-all bg-black/50 backdrop-blur-md shadow-lg" title="Open in New Tab">
                        <i class="fa-solid fa-up-right-from-square text-xs"></i>
                    </a>
                    <button onclick="closePreview()" class="glass px-4 h-9 rounded-full flex items-center text-xs font-mono text-white hover:bg-red-500/20 hover:border-red-500/50 hover:text-red-300 transition-all bg-black/50 backdrop-blur-md shadow-lg group">
                        <i class="fa-solid fa-xmark mr-2 group-hover:rotate-90 transition-transform"></i> CLOSE
                    </button>
                </div>
            </div>

            <!-- The Iframe (Full Height) -->
            <iframe id="preview-frame" class="flex-1 w-full h-full border-none bg-white" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
        </div>

    </main>

    <!-- Footer Status Bar -->
    <footer class="h-8 bg-[#09090b] border-t border-white/10 flex items-center justify-between px-4 text-[10px] font-mono text-term-dim select-none z-40">
        <div class="flex items-center space-x-4">
            <span id="status-items">0 ITEMS</span>
            <span id="status-size">-- KB</span>
        </div>
        <div class="flex items-center space-x-4">
            <span>UTF-8</span>
            <span>JAVASCRIPT: ENABLED</span>
            <span class="text-term-accent">V.2.0.4</span>
        </div>
    </footer>

    <script>
        /**
         * CONFIGURATION
         * * By default, the script tries to detect your username and repo from the URL.
         * If you are running locally or want to override, set these values manually.
         * Example:
         * const MANUAL_USERNAME = 'your-username';
         * const MANUAL_REPO = 'your-repo-name';
         */
        const MANUAL_USERNAME = null; 
        const MANUAL_REPO = null;

        // --- State ---
        let currentPath = ''; // Root
        let repoDetails = { user: '', repo: '' };
        let cache = {}; // Simple cache to prevent re-fetching

        // --- DOM Elements ---
        const grid = document.getElementById('file-grid');
        const loader = document.getElementById('loading');
        const errorView = document.getElementById('error-msg');
        const breadcrumbContainer = document.getElementById('breadcrumb-container');
        const previewOverlay = document.getElementById('preview-overlay');
        const previewFrame = document.getElementById('preview-frame');

        // --- Initialization ---
        async function init() {
            detectRepoDetails();
            
            // If we are on localhost and no manual config, load demo data
            if ((!repoDetails.user || !repoDetails.repo) && window.location.hostname === 'localhost' && !MANUAL_USERNAME) {
                console.warn('Localhost detected with no config. Loading demo data.');
                loadDemoData();
                return;
            }

            if (!repoDetails.user || !repoDetails.repo) {
                showError('Could not detect GitHub repository. Please configure MANUAL_USERNAME in source code.');
                return;
            }

            // Update UI
            document.getElementById('repo-label').textContent = `${repoDetails.user}/${repoDetails.repo}`;
            document.getElementById('github-link').href = `https://github.com/${repoDetails.user}/${repoDetails.repo}`;

            // Load Root
            await loadPath('');
        }

        function detectRepoDetails() {
            if (MANUAL_USERNAME && MANUAL_REPO) {
                repoDetails = { user: MANUAL_USERNAME, repo: MANUAL_REPO };
                return;
            }

            const hostname = window.location.hostname; // e.g., username.github.io
            const pathname = window.location.pathname; // e.g., /repo-name/ or /repo-name/index.html

            if (hostname.includes('github.io')) {
                repoDetails.user = hostname.split('.')[0];
                // Repo is usually the first segment of path
                const pathParts = pathname.split('/').filter(p => p);
                if (pathParts.length > 0) {
                    repoDetails.repo = pathParts[0];
                }
            }
        }

        // --- Core Logic ---

        async function loadPath(path) {
            currentPath = path;
            updateBreadcrumbs();
            showLoading(true);
            errorView.classList.add('hidden');

            try {
                let data;
                
                // Check Cache
                if (cache[path]) {
                    data = cache[path];
                } else {
                    // Fetch from API
                    const apiUrl = `https://api.github.com/repos/${repoDetails.user}/${repoDetails.repo}/contents/${path}`;
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        if (response.status === 403) throw new Error('API Rate Limit Exceeded. Try again later.');
                        if (response.status === 404) throw new Error('Directory not found.');
                        throw new Error('Failed to fetch data.');
                    }
                    
                    data = await response.json();
                    
                    // Sort: Folders first, then files
                    if (Array.isArray(data)) {
                        data.sort((a, b) => {
                            if (a.type === b.type) return a.name.localeCompare(b.name);
                            return a.type === 'dir' ? -1 : 1;
                        });
                        cache[path] = data; // Save to cache
                    }
                }

                renderGrid(data);

            } catch (err) {
                console.error(err);
                showError(err.message);
            } finally {
                showLoading(false);
            }
        }

        function renderGrid(items) {
            grid.innerHTML = '';
            
            // Layout Logic:
            // Root = Grid view (Dashboard style)
            // Nested = List view (Links style)
            if (currentPath === '') {
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20';
            } else {
                grid.className = 'flex flex-col gap-2 pb-20 max-w-4xl mx-auto';
            }
            
            if (!Array.isArray(items)) {
                return; 
            }

            // Filter out index.html if in root
            const filteredItems = items.filter(item => {
                if (currentPath === '' && item.name === 'index.html') return false;
                if (item.name.startsWith('.')) return false; // Hide dotfiles
                return true;
            });

            document.getElementById('status-items').textContent = `${filteredItems.length} OBJECTS`;

            if (filteredItems.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-term-dim font-mono">
                        <i class="fa-solid fa-folder-open mb-2 text-2xl"></i><br>
                        DIRECTORY EMPTY
                    </div>
                `;
                return;
            }

            // Back Button if not root
            if (currentPath !== '') {
                const backCard = createCard({
                    name: '..',
                    type: 'back'
                });
                grid.appendChild(backCard);
            }

            filteredItems.forEach(item => {
                const card = createCard(item);
                grid.appendChild(card);
            });
        }

        function createCard(item) {
            const el = document.createElement('div');
            const isRoot = currentPath === '';
            
            // --- BACK BUTTON ---
            if (item.type === 'back') {
                // List View Back Button
                el.className = 'p-3 rounded cursor-pointer group flex items-center text-term-dim hover:text-white hover:bg-white/5 transition-colors border border-transparent hover:border-white/10 mb-2 font-mono text-xs';
                el.innerHTML = `
                    <i class="fa-solid fa-turn-up text-sm mr-3"></i>
                    <span>.. / BACK_TO_PARENT</span>
                `;
                el.onclick = () => {
                    const parts = currentPath.split('/');
                    parts.pop();
                    loadPath(parts.join('/'));
                };
                return el;
            }

            // --- STANDARD ITEMS ---
            
            if (isRoot) {
                // *** ROOT: BOX / CARD LAYOUT ***
                el.className = 'glass-card p-5 rounded cursor-pointer group relative overflow-hidden flex flex-col justify-between h-40';
                
                // Root Icons
                let iconClass = 'fa-folder';
                let colorClass = 'text-term-accent';
                let typeLabel = 'DIRECTORY';

                if (item.type !== 'dir') {
                    // Files in root (if any)
                    iconClass = 'fa-file';
                    colorClass = 'text-term-dim';
                    typeLabel = 'FILE';
                }

                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <i class="fa-solid ${iconClass} text-3xl ${colorClass} group-hover:scale-110 transition-transform duration-300"></i>
                        <div class="w-2 h-2 rounded-full bg-term-accent opacity-50"></div>
                    </div>
                    
                    <div class="z-10">
                        <h3 class="font-mono text-sm font-bold text-gray-200 truncate group-hover:text-term-accent transition-colors">${item.name}</h3>
                        <p class="font-mono text-[10px] text-term-dim uppercase mt-1">${typeLabel}</p>
                    </div>

                    <div class="absolute -bottom-4 -right-4 text-6xl opacity-5 group-hover:opacity-10 transition-opacity text-white select-none pointer-events-none">
                        ${item.name.charAt(0).toUpperCase()}
                    </div>
                `;

            } else {
                // *** NESTED: LIST / LINK LAYOUT ***
                el.className = 'glass p-3 rounded cursor-pointer group flex items-center justify-between hover:bg-white/5 transition-colors border border-transparent hover:border-white/10';
                
                // List Icons
                let iconClass = 'fa-file text-term-dim';
                let colorClass = 'text-term-dim';
                let typeLabel = item.size ? formatBytes(item.size) : 'FILE';

                if (item.type === 'dir') {
                    iconClass = 'fa-link'; 
                    colorClass = 'text-term-success';
                    typeLabel = 'PROJECT';
                } else if (item.name.endsWith('.html')) {
                    iconClass = 'fa-brands fa-html5';
                    colorClass = 'text-orange-400';
                } else if (item.name.endsWith('.js')) {
                    iconClass = 'fa-brands fa-js';
                    colorClass = 'text-yellow-400';
                } else if (item.name.endsWith('.css')) {
                    iconClass = 'fa-brands fa-css3-alt';
                    colorClass = 'text-blue-400';
                } else if (item.name.endsWith('.md')) {
                    iconClass = 'fa-brands fa-markdown';
                    colorClass = 'text-white';
                }

                el.innerHTML = `
                    <div class="flex items-center space-x-3 overflow-hidden">
                        <div class="w-6 text-center"><i class="fa-solid ${iconClass} text-lg ${colorClass}"></i></div>
                        <span class="font-mono text-sm text-gray-300 group-hover:text-white truncate transition-colors">${item.name}</span>
                    </div>
                    
                    <div class="flex items-center space-x-4 pl-4 shrink-0">
                        <span class="font-mono text-[10px] text-term-dim uppercase hidden sm:inline-block">${typeLabel}</span>
                        <i class="fa-solid fa-chevron-right text-[10px] text-term-dim opacity-0 group-hover:opacity-100 transition-opacity transform group-hover:translate-x-1"></i>
                    </div>
                `;
            }

            el.onclick = () => handleItemClick(item);

            return el;
        }

        async function handleItemClick(item) {
            if (item.type === 'dir') {
                // CRITICAL REQUIREMENT: Check contents for index.html
                showLoading(true);
                try {
                    const nextPath = currentPath ? `${currentPath}/${item.name}` : item.name;
                    
                    // Fetch contents of this directory
                    const apiUrl = `https://api.github.com/repos/${repoDetails.user}/${repoDetails.repo}/contents/${nextPath}`;
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (Array.isArray(data)) {
                        // Check if index.html exists
                        const hasIndex = data.find(f => f.name === 'index.html');
                        
                        if (hasIndex) {
                            // Render Content (Open Preview)
                            // Construct GitHub Pages URL
                            const pageUrl = `https://${repoDetails.user}.github.io/${repoDetails.repo}/${nextPath}/`;
                            openPreview(item.name, pageUrl);
                            
                            // Cache this data anyway to save bandwidth if they navigate manually later
                            cache[nextPath] = data;
                        } else {
                            // No index.html, navigate normally
                            loadPath(nextPath);
                        }
                    }
                } catch (e) {
                    console.error('Error peeking folder', e);
                    // Fallback to just trying to load it normally
                    loadPath(currentPath ? `${currentPath}/${item.name}` : item.name);
                } finally {
                    showLoading(false);
                }

            } else {
                // It's a file
                if (item.name.endsWith('.html')) {
                    const pageUrl = `https://${repoDetails.user}.github.io/${repoDetails.repo}/${currentPath ? currentPath + '/' : ''}${item.name}`;
                    openPreview(item.name, pageUrl);
                } else {
                    // Open source in new tab
                    window.open(item.html_url, '_blank');
                }
            }
        }

        // --- Preview Logic ---
        function openPreview(title, url) {
            document.getElementById('preview-title').textContent = title.toUpperCase();
            previewFrame.src = url;
            document.getElementById('preview-external-link').href = url;
            previewOverlay.classList.remove('translate-y-full');
        }

        function closePreview() {
            previewOverlay.classList.add('translate-y-full');
            // Clear src after animation to stop audio/video
            setTimeout(() => {
                previewFrame.src = 'about:blank';
            }, 500);
        }

        // --- Helpers ---

        function updateBreadcrumbs() {
            const parts = currentPath.split('/').filter(p => p);
            breadcrumbContainer.innerHTML = `<span class="text-term-accent hover:text-white cursor-pointer transition-colors" onclick="loadPath('')">~/</span>`;
            
            let accum = '';
            parts.forEach((part, index) => {
                accum += (index === 0 ? '' : '/') + part;
                const pathRef = accum;
                const isLast = index === parts.length - 1;
                
                breadcrumbContainer.innerHTML += `
                    <span class="text-term-dim">/</span>
                    <span class="${isLast ? 'text-white font-bold' : 'text-term-dim hover:text-white cursor-pointer transition-colors'}" 
                          onclick="${!isLast ? `loadPath('${pathRef}')` : ''}">${part}</span>
                `;
            });
        }

        function resetToRoot() {
            loadPath('');
        }

        function showLoading(isLoading) {
            if(isLoading) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        function showError(msg) {
            errorView.classList.remove('hidden');
            document.getElementById('error-text').textContent = msg;
            grid.innerHTML = '';
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        // --- Demo Data for Localhost ---
        function loadDemoData() {
            document.getElementById('repo-label').textContent = "DEMO/MODE";
            const demoItems = [
                { name: 'Project-Alpha', type: 'dir' },
                { name: 'Portfolio-V1', type: 'dir' },
                { name: 'Experiment-Labs', type: 'dir' },
                { name: 'README.md', type: 'file', size: 2048, html_url: '#' },
                { name: 'style.css', type: 'file', size: 1024, html_url: '#' }
            ];
            
            // Mock the fetch behavior for demo
            window.fetch = async (url) => {
                // Simulate delay
                await new Promise(r => setTimeout(r, 600));
                
                // If checking inside a folder in demo mode
                if (url.includes('Project-Alpha')) {
                    return { ok: true, json: async () => [{ name: 'index.html', type: 'file' }, { name: 'app.js', type: 'file' }] };
                }
                
                return { ok: true, json: async () => demoItems };
            };
            
            loadPath('');
        }

        // Start
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
