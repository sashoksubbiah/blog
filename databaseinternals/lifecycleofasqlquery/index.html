<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL Point Query Lifecycle Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* --- CSS STYLING --- */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #38bdf8; /* Sky 400 */
            margin-bottom: 10px;
            font-weight: 300;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            background: #1e293b; /* Slate 800 */
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            padding: 20px;
            box-sizing: border-box;
        }

        /* Controls Area */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            background: #020617;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .query-box {
            font-family: 'Courier New', monospace;
            background: #0f172a;
            color: #a5f3fc;
            border: 1px solid #334155;
            padding: 10px;
            border-radius: 4px;
            width: 300px;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        #btn-next { background-color: #3b82f6; color: white; }
        #btn-next:hover { background-color: #2563eb; }
        #btn-next:disabled { background-color: #475569; cursor: not-allowed; opacity: 0.7; }

        #btn-reset { background-color: #ef4444; color: white; }
        #btn-reset:hover { background-color: #dc2626; }

        /* Explanation Panel */
        .info-panel {
            background: #334155;
            border-left: 5px solid #3b82f6;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            min-height: 80px;
        }

        .info-title { font-weight: bold; color: #38bdf8; margin-bottom: 5px; display: block; }
        .info-text { font-size: 15px; line-height: 1.5; }
        .tech-detail { font-size: 13px; color: #94a3b8; margin-top: 5px; font-style: italic; }

        /* Visualization SVG */
        #viz-container {
            width: 100%;
            height: 600px;
            background: #020617;
            border-radius: 8px;
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }

        /* D3 Elements */
        .phase-box rect { fill: #1e293b; stroke: #475569; stroke-width: 2px; rx: 6; }
        .phase-box text { fill: #cbd5e1; font-size: 12px; font-weight: 600; text-anchor: middle; pointer-events: none; }
        
        .phase-active rect { stroke: #fbbf24; stroke-width: 3px; fill: #283547; filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.3)); }
        .phase-active text { fill: #fbbf24; }

        .packet { fill: #38bdf8; filter: drop-shadow(0 0 4px #38bdf8); }
        .packet-text { font-size: 10px; fill: #0f172a; font-weight: bold; text-anchor: middle; pointer-events: none; }

        /* B+ Tree Styling */
        .node circle { fill: #1e293b; stroke: #64748b; stroke-width: 2px; }
        .node text { font: 12px sans-serif; fill: #e2e8f0; pointer-events: none; }
        .link { fill: none; stroke: #475569; stroke-width: 1.5px; opacity: 0.5; }

        .node-active circle { stroke: #fbbf24; stroke-width: 3px; fill: #334155; }
        .node-found circle { stroke: #22c55e; stroke-width: 3px; fill: #14532d; }
        .link-active { stroke: #fbbf24; stroke-width: 3px; opacity: 1; }

        /* Page Directory Internal View */
        .page-detail-g rect { fill: #0f172a; stroke: #fbbf24; stroke-width: 1px; stroke-dasharray: 4; }
        .record-rect { fill: #334155; stroke: none; rx: 2; }
        .record-found { fill: #22c55e; }
        
    </style>
</head>
<body>

    <h1>MySQL Internal Lifecycle: Point Query</h1>

    <div class="container">
        <!-- Controls -->
        <div class="controls">
            <div class="query-box">SELECT * FROM users WHERE id=42</div>
            <button id="btn-next" onclick="nextStep()">Start Execution ▶</button>
            <button id="btn-reset" onclick="resetViz()">Reset ⟲</button>
        </div>

        <!-- Explanation Area -->
        <div class="info-panel">
            <span class="info-title" id="info-title">Ready to Start</span>
            <div class="info-text" id="info-text">Click "Start Execution" to trace the query `SELECT * FROM users WHERE id = 42` through the MySQL kernel.</div>
            <div class="tech-detail" id="tech-detail"></div>
        </div>

        <!-- Visualization Stage -->
        <div id="viz-container"></div>
    </div>

    <script>
        // --- D3 SETUP ---
        const width = 1000;
        const height = 600;
        const margin = { top: 50, right: 50, bottom: 50, left: 50 };
        
        const svg = d3.select("#viz-container")
            .append("svg")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet");

        // --- DATA STRUCTURES ---

        // 1. Pipeline Phases
        const phases = [
            { id: "client", label: "Client", x: 100, y: 80 },
            { id: "conn", label: "Connection", x: 300, y: 80 },
            { id: "parser", label: "Parser & Opt", x: 500, y: 80 },
            { id: "innodb", label: "InnoDB Buffer", x: 700, y: 80 },
            { id: "disk", label: "Disk Storage", x: 900, y: 80 }
        ];

        // 2. B+ Tree Data (Simplified)
        // Root: [10, 50] -> Children cover ranges <10, 10-50, >50
        const treeData = {
            name: "Root Page (Pg 10)",
            type: "internal",
            keys: "Keys: [10, 50]",
            children: [
                { name: "Pg 20", type: "leaf", keys: "< 10", hidden: true }, 
                { 
                    name: "Pg 21", 
                    type: "leaf", 
                    keys: "10 <= id < 50", 
                    isTarget: true,
                    records: [12, 25, 42, 48] 
                },
                { name: "Pg 22", type: "leaf", keys: "> 50", hidden: true }
            ]
        };

        // --- STATE MANAGEMENT ---
        let stepIndex = 0;
        const totalSteps = 9;
        
        // Define the storyboard
        const storyboard = [
            {
                title: "Phase 1: Connection",
                text: "The client sends the SQL packet via TCP/IP. The Connection Manager assigns a thread.",
                tech: "Command: COM_QUERY (0x03). A new THD (Thread Descriptor) is initialized.",
                action: () => {
                    drawPipeline();
                    animatePacket(phases[0], phases[1], "SQL");
                    highlightPhase("conn");
                }
            },
            {
                title: "Phase 2: Parsing",
                text: "The thread passes the SQL text to the Parser. It checks syntax and builds a Parse Tree.",
                tech: "File: sql_yacc.yy. Output: SELECT_LEX structure (Abstract Syntax Tree).",
                action: () => {
                    animatePacket(phases[1], phases[2], "AST");
                    highlightPhase("parser");
                }
            },
            {
                title: "Phase 3: Resolution & Optimization",
                text: "The server resolves table names and decides the best way to execute the query.",
                tech: "Optimizer sees 'WHERE id=42'. Since 'id' is Primary Key, it chooses Access Type: const (EQ_REF). Cost: ~1.0.",
                action: () => {
                    highlightPhase("parser"); // Stay on parser/opt
                    // Flash effect to symbolize "Thinking"
                    d3.select("#phase-parser rect")
                        .transition().duration(200).style("fill", "#475569")
                        .transition().duration(200).style("fill", "#283547");
                }
            },
            {
                title: "Phase 4: Execution Start",
                text: "The Executor requests the row from the Storage Engine (InnoDB).",
                tech: "Function call: handler::ha_index_read_map(key=42).",
                action: () => {
                    animatePacket(phases[2], phases[3], "Get 42");
                    highlightPhase("innodb");
                    drawTree(); // Show the tree now
                }
            },
            {
                title: "Phase 5: B+ Tree Root Search",
                text: "InnoDB looks at the Root Page (cached in Buffer Pool). It compares 42 against keys [10, 50].",
                tech: "42 > 10 and 42 < 50. The pointer indicates the child page is Page 21.",
                action: () => {
                    highlightNode(rootNode.descendants()[0]); // Root
                }
            },
            {
                title: "Phase 5: Tree Traversal",
                text: "Following the pointer down to the Leaf Level.",
                tech: "Skipping Page 20 and 22. This 'Index Selectivity' is why B-Trees are fast (O(log N)).",
                action: () => {
                    // Highlight link to middle child
                    const link = d3.select("path.link[target-name='Pg 21']");
                    link.attr("class", "link link-active");
                }
            },
            {
                title: "Phase 5: Leaf Page Search",
                text: "We arrive at Leaf Page 21. This page contains the actual row data.",
                tech: "Page loaded from Buffer Pool (or Disk if missing).",
                action: () => {
                    highlightNode(rootNode.descendants().find(d => d.data.name === "Pg 21"));
                }
            },
            {
                title: "Phase 5: Page Internals",
                text: "Inside the page (16KB), InnoDB uses the Page Directory to jump close to the record.",
                tech: "Binary Search on Directory Slots -> Linear Scan on Linked List -> Record Found.",
                action: () => {
                    const targetNode = rootNode.descendants().find(d => d.data.name === "Pg 21");
                    showPageInternals(targetNode);
                }
            },
            {
                title: "Phase 7: Result Transmission",
                text: "The row is found! It passes the MVCC visibility check and is sent back to the client.",
                tech: "Protocol: Text Protocol. The integer 42 is converted to string '42' before sending.",
                action: () => {
                    d3.select(".page-detail-group").remove(); // Clean up detail view
                    animatePacket(phases[3], phases[0], "Result", 1500); // Long return trip
                    highlightPhase("client");
                }
            }
        ];

        // --- RENDER FUNCTIONS ---

        function drawPipeline() {
            // Draw connecting lines
            svg.append("line")
                .attr("x1", 100).attr("y1", 80)
                .attr("x2", 900).attr("y2", 80)
                .attr("stroke", "#475569")
                .attr("stroke-width", 2);

            // Draw boxes
            const g = svg.selectAll(".phase-group")
                .data(phases)
                .enter().append("g")
                .attr("class", "phase-group")
                .attr("id", d => "phase-" + d.id)
                .attr("transform", d => `translate(${d.x}, ${d.y})`);

            g.append("rect")
                .attr("x", -60).attr("y", -25)
                .attr("width", 120).attr("height", 50);

            g.append("text")
                .attr("dy", 5)
                .text(d => d.label);
        }

        let rootNode; // Store d3 hierarchy root

        function drawTree() {
            // Container for tree
            const treeG = svg.append("g")
                .attr("transform", "translate(0, 200)");

            const treeLayout = d3.tree().size([width, 250]);
            const root = d3.hierarchy(treeData);
            rootNode = treeLayout(root);

            // Links
            treeG.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("target-name", d => d.target.data.name)
                .attr("d", d3.linkVertical()
                    .x(d => d.x)
                    .y(d => d.y)
                );

            // Nodes
            const nodes = treeG.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .style("opacity", 0); // Start invisible

            nodes.append("circle")
                .attr("r", 25);

            nodes.append("text")
                .attr("dy", 45)
                .style("text-anchor", "middle")
                .style("font-weight", "bold")
                .text(d => d.data.name);

            nodes.append("text")
                .attr("dy", 5)
                .style("text-anchor", "middle")
                .style("font-size", "10px")
                .text(d => d.data.keys);

            // Fade in
            nodes.transition().duration(500).style("opacity", 1);
        }

        function highlightPhase(id) {
            d3.selectAll(".phase-group").attr("class", "phase-group"); // Reset
            d3.select("#phase-" + id).attr("class", "phase-group phase-active");
        }

        function highlightNode(d3Node) {
            // Find the specific DOM element based on data
            svg.selectAll(".node")
                .filter(d => d === d3Node)
                .classed("node-active", true);
        }

        function animatePacket(source, target, label, duration = 1000) {
            const packet = svg.append("g")
                .attr("class", "packet-g")
                .attr("transform", `translate(${source.x}, ${source.y})`);

            packet.append("circle")
                .attr("class", "packet")
                .attr("r", 10);
            
            packet.append("text")
                .attr("class", "packet-text")
                .attr("dy", 4)
                .text(label);

            packet.transition()
                .duration(duration)
                .attr("transform", `translate(${target.x}, ${target.y})`)
                .on("end", () => packet.remove());
        }

        function showPageInternals(targetNode) {
            // Draw a detail view near the node
            const x = targetNode.x;
            const y = targetNode.y + 200 + 60; // Offset from tree

            const g = svg.append("g")
                .attr("class", "page-detail-group")
                .attr("transform", `translate(${x - 100}, ${y})`)
                .style("opacity", 0);

            // Page Container
            g.append("rect")
                .attr("width", 200).attr("height", 80)
                .attr("fill", "#1e293b")
                .attr("stroke", "#fbbf24")
                .attr("stroke-width", 2)
                .attr("rx", 5);

            g.append("text")
                .attr("x", 10).attr("y", 20)
                .attr("fill", "#94a3b8")
                .style("font-size", "10px")
                .text("Page Directory & Records");

            // Draw Records (Boxes)
            const records = targetNode.data.records; // [12, 25, 42, 48]
            records.forEach((rec, i) => {
                const rG = g.append("g").attr("transform", `translate(${20 + i*45}, 40)`);
                
                const rect = rG.append("rect")
                    .attr("class", "record-rect")
                    .attr("width", 35).attr("height", 25)
                    .attr("id", "rec-" + rec);
                
                rG.append("text")
                    .attr("x", 17.5).attr("y", 17)
                    .attr("text-anchor", "middle")
                    .attr("fill", "white")
                    .style("font-size", "11px")
                    .text(rec);
            });

            g.transition().duration(500).style("opacity", 1)
             .on("end", () => {
                 // Animate Search
                 setTimeout(() => {
                     d3.select("#rec-42")
                        .transition().duration(300)
                        .attr("fill", "#22c55e") // Green found
                        .attr("transform", "scale(1.2) translate(-3, -3)"); // Pop out
                 }, 500);
             });
        }

        // --- CONTROLLER ---

        function nextStep() {
            const btn = document.getElementById("btn-next");
            
            if (stepIndex < storyboard.length) {
                const step = storyboard[stepIndex];
                
                // Update UI Text
                document.getElementById("info-title").innerText = step.title;
                document.getElementById("info-text").innerText = step.text;
                document.getElementById("tech-detail").innerText = step.tech;

                // Execute Visualization Logic
                step.action();

                stepIndex++;
                btn.innerText = (stepIndex >= storyboard.length) ? "Done" : "Next ▶";
                if (stepIndex >= storyboard.length) btn.disabled = true;
            }
        }

        function resetViz() {
            stepIndex = 0;
            const btn = document.getElementById("btn-next");
            btn.disabled = false;
            btn.innerText = "Start Execution ▶";
            
            // Reset Text
            document.getElementById("info-title").innerText = "Ready to Start";
            document.getElementById("info-text").innerText = "Click 'Start Execution' to trace the query...";
            document.getElementById("tech-detail").innerText = "";

            // Clear SVG
            svg.selectAll("*").remove();
        }

        // Initial setup
        resetViz(); // Ensures SVG is clear
        drawPipeline(); // Show initial pipeline state

    </script>
</body>
</html>
