<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL Point Query: The Data Stack</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* --- MODERN THEME & LAYOUT --- */
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --highlight: #38bdf8;
            --accent: #f59e0b;
            --success: #10b981;
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            overflow: auto; 
        }

        /* --- SIDEBAR (Timeline) --- */
        aside {
            width: 300px;
            min-width: 300px;
            background: #020617;
            border-right: 1px solid #334155;
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 10;
            height: 100vh;
            overflow: hidden; 
            position: sticky;
            top: 0;
        }

        h1 { 
            font-size: 1.2rem; 
            margin-bottom: 1.5rem; 
            color: var(--highlight);
            flex-shrink: 0; 
        }
        
        .timeline { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            margin-bottom: 20px;
            flex-grow: 1; 
            overflow-y: auto; 
            padding-right: 5px; 
        }
        
        .timeline::-webkit-scrollbar { width: 6px; }
        .timeline::-webkit-scrollbar-track { background: #0f172a; }
        .timeline::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        .timeline-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #334155;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .timeline-item.active {
            background: #1e293b;
            border-left-color: var(--highlight);
            color: var(--text-main);
            font-weight: 600;
            transform: translateX(5px);
        }
        .timeline-item.done { border-left-color: var(--success); opacity: 0.6; }

        /* --- CONTROLS --- */
        .controls-area {
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
            padding-bottom: 20px;
            flex-shrink: 0; 
        }
        .control-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: 0.2s;
        }
        .btn-primary { background: var(--highlight); color: #0f172a; }
        .btn-primary:hover { background: #0ea5e9; }
        .btn-primary:disabled { background: #475569; cursor: not-allowed; }
        .btn-reset { background: transparent; color: #ef4444; border: 1px solid #ef4444; }
        .btn-reset:hover { background: rgba(239, 68, 68, 0.1); }

        /* --- MAIN STAGE --- */
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100vh;
            overflow: hidden;
        }

        /* Info Header */
        .status-bar {
            padding: 20px 40px;
            background: rgba(15, 23, 42, 0.9);
            border-bottom: 1px solid #334155;
            min-height: 80px;
            flex-shrink: 0;
        }
        .status-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; color: var(--highlight); }
        .status-desc { color: var(--text-dim); font-size: 0.95rem; line-height: 1.4; max-width: 800px; }

        /* Visualization Area */
        #viz-container {
            flex-grow: 1;
            position: relative;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        @media (max-width: 800px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            aside { 
                width: 100%; 
                min-width: 0;
                height: auto; 
                border-right: none; 
                border-bottom: 1px solid #334155;
                position: relative;
                overflow: visible; 
            }
            .timeline { overflow-y: visible; } 
            main { height: 600px; overflow: visible; }
        }

        /* --- D3 STYLES --- */
        /* Increased Font Sizes for Visibility */
        .layer-rect { fill: var(--card-bg); stroke: #475569; stroke-width: 2px; rx: 8; }
        .layer-label { fill: #94a3b8; font-weight: bold; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }
        
        .layer-active .layer-rect { stroke: var(--highlight); stroke-width: 3px; filter: drop-shadow(0 0 8px rgba(56, 189, 248, 0.2)); }
        .layer-active .layer-label { fill: var(--highlight); }

        .packet-glow { fill: var(--highlight); filter: blur(4px); opacity: 0.6; }
        .packet-core { fill: #fff; }
        .packet-text { font-size: 14px; font-weight: bold; fill: #0f172a; text-anchor: middle; }

        .pipe-line { stroke: #334155; stroke-width: 4px; stroke-dasharray: 8 4; }

        .tree-node circle { fill: #334155; stroke: #64748b; stroke-width: 2px; }
        .tree-node text { fill: #e2e8f0; font-size: 14px; pointer-events: none; text-anchor: middle; }
        .tree-link { fill: none; stroke: #475569; stroke-width: 1.5px; opacity: 0.4; }
        
        .node-active circle { stroke: var(--accent); stroke-width: 3px; fill: #451a03; }
        .node-found circle { stroke: var(--success); fill: #064e3b; }

        .detail-bg { fill: #020617; stroke: var(--highlight); stroke-width: 1px; rx: 6; }
        .detail-slot { fill: #1e293b; stroke: #475569; }
        .detail-slot.found { fill: var(--success); stroke: var(--success); }

    </style>
</head>
<body>

    <aside>
        <h1>MySQL Deep Dive</h1>
        
        <!-- Controls -->
        <div class="controls-area">
            <button id="btn-next" class="control-btn btn-primary" onclick="nextStep()">Start Journey ▶</button>
            <button class="control-btn btn-reset" onclick="resetViz()">Reset</button>
        </div>

        <ul class="timeline" id="timeline-list">
            <!-- Populated by JS -->
        </ul>
    </aside>

    <main>
        <div class="status-bar">
            <div id="status-title" class="status-title">Ready</div>
            <div id="status-desc" class="status-desc">Click Start to trace `SELECT * FROM users WHERE id=42` down the stack.</div>
        </div>
        <div id="viz-container"></div>
    </main>

    <script>
        // --- CONFIGURATION ---
        // CHANGED: Reduced Logical Resolution further to make elements appear larger
        // Width: 540 (fits 500px boxes snugly)
        // Height: 720 (reduced height to prevent vertical shrinking/letterboxing)
        const width = 540;
        const height = 720;
        const centerX = width / 2;

        const svg = d3.select("#viz-container").append("svg")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet")
            .style("width", "100%")
            .style("height", "100%");

        // --- LAYERS DEFINITION (Vertical Stack) ---
        // Compacted Y-coordinates to fit in 720px height
        const layers = [
            { id: "app", label: "Application Layer", y: 20, height: 80 },
            { id: "server", label: "MySQL Server (Parser/Opt)", y: 130, height: 120 },
            { id: "storage", label: "InnoDB Storage Engine", y: 280, height: 420 }, // Taller for clearer tree
        ];

        // --- STORYBOARD ---
        const steps = [
            { id: "conn", label: "Connection", desc: "App sends SQL via TCP. MySQL assigns a Thread.", targetLayer: "app" },
            { id: "parse", label: "Parsing", desc: "Lexer tokens: SELECT, *, FROM... Parser builds AST.", targetLayer: "server" },
            { id: "opt", label: "Optimization", desc: "Optimizer sees 'id' is PK. Plan: const lookup (Cost: 1.0).", targetLayer: "server" },
            { id: "exec", label: "Execution Start", desc: "Executor calls InnoDB API handler::ha_index_read_map(42).", targetLayer: "storage" },
            { id: "tree1", label: "B+ Tree: Root", desc: "Check Root Page (Pg 10). 42 is between 10 and 50.", targetLayer: "storage" },
            { id: "tree2", label: "B+ Tree: Traversal", desc: "Follow pointer to Leaf Page (Pg 21). Skipping others.", targetLayer: "storage" },
            { id: "tree3", label: "Leaf Page Scan", desc: "Page loaded. Binary search on Page Directory finds slot.", targetLayer: "storage" },
            { id: "mvcc", label: "MVCC Visibility", desc: "Multi-Version Concurrency Control: MySQL checks if this row version is visible to your Transaction ID. If not, it follows the Undo Log pointer.", targetLayer: "storage" },
            { id: "return", label: "Return Data", desc: "Data formatted to Text Protocol and sent back up.", targetLayer: "app" }
        ];

        // --- B+ TREE DATA ---
        const treeData = {
            name: "Root",
            children: [
                { name: "< 10", hidden: true },
                { name: "Leaf Pg 21", target: true, records: [12, 25, 42, 48] },
                { name: "> 50", hidden: true }
            ]
        };

        // --- STATE ---
        let currentStep = -1;

        // --- INITIAL RENDER ---
        function init() {
            // 1. Draw Timeline Sidebar
            const list = document.getElementById("timeline-list");
            list.innerHTML = "";
            steps.forEach((s, i) => {
                const li = document.createElement("li");
                li.className = "timeline-item";
                li.id = `step-li-${i}`;
                li.innerText = `${i+1}. ${s.label}`;
                list.appendChild(li);
            });

            // 2. Draw Pipes (Background connectors)
            // Adjusted line length for compacted layout
            svg.append("line").attr("class", "pipe-line")
                .attr("x1", centerX).attr("y1", 60)
                .attr("x2", centerX).attr("y2", 350);

            // 3. Draw Layers
            const layerGroups = svg.selectAll(".layer")
                .data(layers)
                .enter().append("g")
                .attr("class", "layer")
                .attr("id", d => `layer-${d.id}`)
                .attr("transform", d => `translate(${centerX - 250}, ${d.y})`);

            layerGroups.append("rect")
                .attr("class", "layer-rect")
                .attr("width", 500)
                .attr("height", d => d.height);

            layerGroups.append("text")
                .attr("class", "layer-label")
                .attr("x", 20).attr("y", 30)
                .text(d => d.label);

            // 4. Pre-draw Tree (Hidden initially)
            drawTreeInsideStorage();
        }

        function drawTreeInsideStorage() {
            const storageG = d3.select("#layer-storage");
            
            // Tree Group
            const treeG = storageG.append("g")
                .attr("id", "tree-viz")
                .attr("transform", "translate(250, 60)") // Center inside storage box
                .style("opacity", 0.1); // Dimmed initially

            const root = d3.hierarchy(treeData);
            // Increased tree size slightly
            const treeLayout = d3.tree().size([440, 180]);
            treeLayout(root);

            // Links
            treeG.selectAll(".tree-link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "tree-link")
                .attr("d", d3.linkVertical().x(d => d.x - 220).y(d => d.y)); // Offset x to center

            // Nodes
            const nodes = treeG.selectAll(".tree-node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", "tree-node")
                .attr("id", (d,i) => `node-${i}`)
                .attr("transform", d => `translate(${d.x - 220}, ${d.y})`);

            nodes.append("circle").attr("r", 24); // Bigger nodes
            nodes.append("text").attr("dy", 5).text(d => d.data.name.includes("Leaf") ? "Leaf" : "Root");
            
            // Labels for ranges
            nodes.append("text")
                .attr("dy", 40)
                .style("font-size", "12px")
                .style("fill", "#64748b")
                .text(d => d.data.name.includes("Leaf") ? "[10-50]" : "[10, 50]");
        }

        // --- ANIMATION CONTROLLER ---
        function nextStep() {
            if (currentStep >= steps.length - 1) return;
            currentStep++;
            updateUI(currentStep);
            
            const s = steps[currentStep];

            switch(currentStep) {
                case 0: // Connection
                    animatePacket(layers[0], layers[1], "SQL"); 
                    break;
                case 1: // Parse
                    highlightLayer("server");
                    break;
                case 2: // Optimize
                    break;
                case 3: // Exec Start
                    animatePacket(layers[1], layers[2], "Get 42");
                    d3.select("#tree-viz").transition().duration(1000).style("opacity", 1);
                    break;
                case 4: // Tree Root
                    highlightNode(0); // Root
                    break;
                case 5: // Traverse
                    highlightNode(2); // The middle child (Leaf)
                    break;
                case 6: // Leaf Scan (Zoom in)
                    showPageDetails();
                    break;
                case 7: // MVCC
                    d3.select("#record-42").transition().attr("fill", "#10b981");
                    break;
                case 8: // Return
                    d3.select("#page-zoom").transition().style("opacity", 0); 
                    animatePacket(layers[2], layers[0], "Result", 1500);
                    break;
            }
        }

        // --- ANIMATION HELPERS ---

        function updateUI(index) {
            d3.selectAll(".timeline-item").classed("active", false);
            const activeItem = document.getElementById(`step-li-${index}`);
            if (activeItem) {
                activeItem.classList.add("active", "done");
                activeItem.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }
            
            d3.select("#status-title").text(steps[index].label);
            d3.select("#status-desc").text(steps[index].desc);

            const btn = document.getElementById("btn-next");
            if (index === steps.length - 1) {
                btn.innerText = "Done";
                btn.disabled = true;
            } else {
                btn.innerText = "Next Step ▼";
            }
        }

        function highlightLayer(id) {
            d3.selectAll(".layer").classed("layer-active", false);
            d3.select(`#layer-${id}`).classed("layer-active", true);
        }

        function highlightNode(index) {
            d3.selectAll(".tree-node").classed("node-active", false);
            d3.select(`#node-${index}`).classed("node-active", true);
        }

        function animatePacket(fromLayer, toLayer, text, duration = 1000) {
            highlightLayer(toLayer.id);
            
            const startY = fromLayer.y + (fromLayer.height/2);
            const endY = toLayer.y + (toLayer.height/2);

            const packet = svg.append("g")
                .attr("transform", `translate(${centerX}, ${startY})`);

            packet.append("circle").attr("r", 18).attr("class", "packet-glow"); // Bigger packet
            packet.append("circle").attr("r", 10).attr("class", "packet-core");
            packet.append("text").attr("class", "packet-text").attr("dy", 5).text(text);

            packet.transition()
                .duration(duration)
                .attr("transform", `translate(${centerX}, ${endY})`)
                .on("end", function() {
                    d3.select(this).remove();
                });
        }

        function showPageDetails() {
            const storageG = d3.select("#layer-storage");
            
            const zoomG = storageG.append("g")
                .attr("id", "page-zoom")
                .attr("transform", "translate(125, 290)") // Centered better
                .style("opacity", 0);

            zoomG.append("rect")
                .attr("class", "detail-bg")
                .attr("width", 250).attr("height", 100); // Bigger detail box
            
            zoomG.append("text")
                .attr("x", 15).attr("y", 25)
                .style("fill", "#94a3b8").style("font-size", "14px") // Bigger text
                .text("Leaf Page Internals (Directory)");

            const data = [12, 25, 42, 48];
            data.forEach((val, i) => {
                const g = zoomG.append("g").attr("transform", `translate(${25 + i*55}, 45)`);
                g.append("rect")
                    .attr("class", "detail-slot")
                    .attr("id", `record-${val}`)
                    .attr("width", 45).attr("height", 40).attr("rx", 4); // Bigger slots
                g.append("text")
                    .attr("x", 22.5).attr("y", 25)
                    .attr("text-anchor", "middle")
                    .style("fill", "#fff").style("font-size", "14px")
                    .text(val);
            });

            zoomG.transition().duration(500).style("opacity", 1);
        }

        function resetViz() {
            currentStep = -1;
            svg.selectAll("*").remove();
            
            // Reset Button
            const btn = document.getElementById("btn-next");
            btn.innerText = "Start Journey ▶";
            btn.disabled = false;
            
            d3.select("#status-title").text("Ready");
            d3.select("#status-desc").text("Click Start to trace `SELECT * FROM users WHERE id=42` down the stack.");
            
            const timelineItems = document.querySelectorAll('.timeline-item');
            timelineItems.forEach(item => {
                item.classList.remove('active', 'done');
            });

            init();
        }

        // Boot
        init();

    </script>
</body>
</html>
