<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2PC Protocol Visualizer</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #e94560;
            --accent-color: #0f3460;
            --success: #4cc9f0;
            --error: #f72585;
            --warning: #fca311;
            --log-bg: #000;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--bg-color);
            color: #fff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        h1, h3 { margin: 0 0 10px 0; color: var(--text-color); }
        
        .controls {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            border: 1px solid var(--accent-color);
        }

        button {
            padding: 10px 20px;
            background: var(--accent-color);
            color: #fff;
            border: 1px solid #fff;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.2s;
        }

        button:hover { background: var(--text-color); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .checkbox-group {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 0.9em;
        }

        .main-stage {
            display: flex;
            flex: 1;
            gap: 20px;
            position: relative;
        }

        /* --- Actors (Coordinator & Participants) --- */
        .actor-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 200px;
        }

        .actor {
            background: var(--card-bg);
            border: 2px solid #555;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
            transition: border-color 0.3s;
        }

        .actor.coordinator { border-color: var(--success); height: 160px; }
        .actor.participant { height: 160px; }
        
        .actor-title { font-weight: bold; text-align: center; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        .state-indicator {
            font-size: 0.8em;
            background: #222;
            padding: 4px;
            text-align: center;
            border-radius: 4px;
        }

        .wal-log {
            font-size: 0.7em;
            background: #000;
            color: #0f0;
            padding: 5px;
            height: 60px;
            overflow-y: auto;
            border: 1px solid #333;
            font-family: monospace;
        }

        /* --- Network & Messages --- */
        .network-space {
            flex: 1;
            position: relative;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            margin: 0 20px;
        }

        .message {
            position: absolute;
            background: #fff;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            transform: translate(-50%, -50%);
            transition: top 1s linear, left 1s linear;
            z-index: 10;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* --- System Log --- */
        .system-log {
            width: 350px;
            background: var(--log-bg);
            border: 1px solid #333;
            padding: 10px;
            overflow-y: auto;
            font-size: 0.8em;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .log-entry { border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-entry.info { color: #888; }
        .log-entry.phase1 { color: var(--warning); }
        .log-entry.phase2 { color: var(--success); }
        .log-entry.error { color: var(--error); }
        .log-timestamp { color: #555; margin-right: 5px; }

        /* --- Status Colors --- */
        .status-init { color: #888; }
        .status-wait { color: var(--warning); }
        .status-prepared { color: var(--success); }
        .status-committed { color: #0f0; font-weight: bold; text-shadow: 0 0 5px #0f0; }
        .status-aborted { color: var(--error); font-weight: bold; text-shadow: 0 0 5px var(--error); }

    </style>
</head>
<body>

    <header>
        <h1>2-Phase Commit (2PC) Visualizer</h1>
        <div style="font-size: 0.8em; color: #aaa;">
            Simulating distributed consensus with Write-Ahead Logging (WAL) and failure modes.
        </div>
    </header>

    <div class="controls">
        <button id="btn-start" onclick="startTransaction()">Start Transaction</button>
        <button id="btn-reset" onclick="resetSystem()">Reset</button>
        
        <div style="border-left: 1px solid #555; padding-left: 15px; display: flex; gap: 15px;">
            <span>Simulate Failures:</span>
            <label class="checkbox-group">
                <input type="checkbox" id="fail-p1"> Node 1 Vote NO
            </label>
            <label class="checkbox-group">
                <input type="checkbox" id="crash-p2"> Node 2 Timeout (Crash)
            </label>
        </div>
    </div>

    <div style="display: flex; flex: 1; min-height: 0;">
        
        <div class="actor-column">
            <div class="actor coordinator" id="coord">
                <div class="actor-title">Coordinator (TM)</div>
                <div class="state-indicator" id="coord-state">STATE: IDLE</div>
                <div class="wal-log" id="coord-wal">
                    <div>[WAL] Ready...</div>
                </div>
            </div>
        </div>

        <div class="network-space" id="network">
            </div>

        <div class="actor-column">
            <div class="actor participant" id="p1">
                <div class="actor-title">Participant 1</div>
                <div class="state-indicator" id="p1-state">STATE: IDLE</div>
                <div class="wal-log" id="p1-wal"><div>[WAL] Ready...</div></div>
            </div>
            <div class="actor participant" id="p2">
                <div class="actor-title">Participant 2</div>
                <div class="state-indicator" id="p2-state">STATE: IDLE</div>
                <div class="wal-log" id="p2-wal"><div>[WAL] Ready...</div></div>
            </div>
            <div class="actor participant" id="p3">
                <div class="actor-title">Participant 3</div>
                <div class="state-indicator" id="p3-state">STATE: IDLE</div>
                <div class="wal-log" id="p3-wal"><div>[WAL] Ready...</div></div>
            </div>
        </div>

        <div class="system-log" id="sys-log">
            <div class="log-entry info">System initialized. Waiting for transaction...</div>
        </div>

    </div>

<script>
    // --- Configuration ---
    const NETWORK_DELAY_MS = 1500;
    const PROCESSING_DELAY_MS = 800;
    const TIMEOUT_MS = 4000;

    // --- State Management ---
    const PARTICIPANTS = ['p1', 'p2', 'p3'];
    let isRunning = false;

    // --- Logger ---
    function log(msg, type = 'info') {
        const logBox = document.getElementById('sys-log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        const time = new Date().toLocaleTimeString().split(' ')[0];
        entry.innerHTML = `<span class="log-timestamp">[${time}]</span> ${msg}`;
        logBox.appendChild(entry);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function walLog(actorId, msg) {
        const box = document.getElementById(`${actorId}-wal`);
        const div = document.createElement('div');
        div.innerText = `> ${msg}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function updateState(actorId, state, statusClass = '') {
        const el = document.getElementById(`${actorId}-state`);
        el.innerText = `STATE: ${state}`;
        el.className = `state-indicator ${statusClass}`;
        
        // Visual feedback on actor box
        const box = document.getElementById(actorId);
        if(state === 'COMMITTED') box.style.borderColor = '#0f0';
        if(state === 'ABORTED') box.style.borderColor = '#f00';
        if(state === 'PREPARED') box.style.borderColor = '#fca311';
        if(state === 'IDLE') box.style.borderColor = '#555';
    }

    // --- Visual Effects ---
    function createMessage(fromId, toId, text, color) {
        return new Promise(resolve => {
            const network = document.getElementById('network');
            const fromEl = document.getElementById(fromId);
            const toEl = document.getElementById(toId);
            
            // Calculate positions relative to network container
            const networkRect = network.getBoundingClientRect();
            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();

            const startX = fromRect.left - networkRect.left + (fromRect.width / (fromId === 'coord' ? 1 : 0)); 
            const startY = fromRect.top - networkRect.top + (fromRect.height / 2);
            
            const endX = toRect.left - networkRect.left + (toId === 'coord' ? 0 : toRect.width); // rough hack for L/R
            const endY = toRect.top - networkRect.top + (toRect.height / 2);

            // Create dot
            const msg = document.createElement('div');
            msg.className = 'message';
            msg.innerText = text;
            msg.style.backgroundColor = color;
            
            // Adjust start point based on column
            msg.style.left = (fromId === 'coord' ? '0%' : '100%');
            msg.style.top = startY + 'px';

            network.appendChild(msg);

            // Force reflow
            void msg.offsetWidth;

            // Animate
            msg.style.left = (toId === 'coord' ? '0%' : '90%');
            msg.style.top = endY + 'px';

            setTimeout(() => {
                msg.remove();
                resolve();
            }, NETWORK_DELAY_MS);
        });
    }

    // --- Core Protocol Logic ---

    async function startTransaction() {
        if (isRunning) return;
        isRunning = true;
        document.getElementById('btn-start').disabled = true;
        resetUI();

        log("--- PHASE 1: VOTING (PREPARE) ---", "phase1");
        
        // 1. Coordinator: Write 'Begin' to Log
        walLog('coord', 'BEGIN TRX');
        updateState('coord', 'PREPARING', 'status-wait');
        
        // 2. Coordinator sends PREPARE to all
        log("Coordinator sending PREPARE to all participants...", "info");
        
        const votePromises = PARTICIPANTS.map(pId => handleParticipantVote(pId));
        
        // Wait for all votes (or timeouts)
        const results = await Promise.all(votePromises);
        
        // Analyze votes
        const allYes = results.every(r => r === 'YES');
        const decision = allYes ? 'COMMIT' : 'ROLLBACK';
        
        log(`--- PHASE 2: COMPLETION (${decision}) ---`, "phase2");
        
        // 3. Coordinator writes decision to WAL (Crucial Point of No Return)
        walLog('coord', `WRITE ${decision}`);
        updateState('coord', decision === 'COMMIT' ? 'COMMITTING' : 'ABORTING');

        // 4. Send Decision to all
        const ackPromises = PARTICIPANTS.map(pId => handleParticipantCompletion(pId, decision));
        
        await Promise.all(ackPromises);
        
        log("Transaction Loop Finished.", "info");
        walLog('coord', 'END TRX');
        updateState('coord', 'IDLE', 'status-init');
        document.getElementById('btn-start').disabled = false;
        isRunning = false;
    }

    async function handleParticipantVote(pId) {
        // Visualize Message: Prepare -> Participant
        await createMessage('coord', pId, 'PREPARE?', '#fff');
        
        // Participant Processing Logic
        updateState(pId, 'WORKING');
        await new Promise(r => setTimeout(r, PROCESSING_DELAY_MS));

        // Check simulation flags
        const failVote = document.getElementById('fail-p1').checked && pId === 'p1';
        const crash = document.getElementById('crash-p2').checked && pId === 'p2';

        if (crash) {
            log(`${pId} CRASHED (Timeout)!`, "error");
            updateState(pId, 'OFFLINE', 'status-aborted');
            return 'NO'; // Implicit NO due to timeout
        }

        if (failVote) {
            log(`${pId} votes NO (Constraint Violation)`, "error");
            walLog(pId, 'ABORT'); // Write abort to local log
            updateState(pId, 'ABORTED', 'status-aborted');
            await createMessage(pId, 'coord', 'VOTE: NO', '#f72585');
            return 'NO';
        } else {
            // Success Case
            log(`${pId} votes YES (Locks acquired)`, "info");
            walLog(pId, 'PREPARED (Locks Held)'); // Durable promise
            updateState(pId, 'PREPARED', 'status-prepared');
            await createMessage(pId, 'coord', 'VOTE: YES', '#4cc9f0');
            return 'YES';
        }
    }

    async function handleParticipantCompletion(pId, decision) {
        // If participant crashed in phase 1, they don't receive phase 2 immediately (simplified)
        const crash = document.getElementById('crash-p2').checked && pId === 'p2';
        if (crash) return;

        // Visualize Message: Decision -> Participant
        const color = decision === 'COMMIT' ? '#4cc9f0' : '#f72585';
        await createMessage('coord', pId, decision, color);

        // Participant writes final state
        walLog(pId, `${decision} (Locks Released)`);
        updateState(pId, decision === 'COMMIT' ? 'COMMITTED' : 'ABORTED', 
                    decision === 'COMMIT' ? 'status-committed' : 'status-aborted');

        // Send ACK
        await new Promise(r => setTimeout(r, 500));
        await createMessage(pId, 'coord', 'ACK', '#ccc');
        log(`${pId} acknowledged ${decision}`, "info");
    }

    function resetUI() {
        document.querySelectorAll('.wal-log').forEach(el => el.innerHTML = '');
        document.querySelectorAll('.state-indicator').forEach(el => {
            el.innerText = 'STATE: IDLE';
            el.className = 'state-indicator';
        });
        document.querySelectorAll('.actor').forEach(el => el.style.borderColor = '#555');
        document.getElementById('sys-log').innerHTML = '<div class="log-entry info">System Ready.</div>';
    }

    function resetSystem() {
        if(isRunning) return;
        resetUI();
        document.getElementById('fail-p1').checked = false;
        document.getElementById('crash-p2').checked = false;
    }

</script>
</body>
</html>
