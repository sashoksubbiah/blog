<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Dive: Secondary Indexes Simulator</title>
    <style>
        :root { --primary: #2563eb; --sec: #1e293b; --accent: #f59e0b; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--sec); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        
        /* Visuals */
        .row { display: flex; padding: 8px; border-bottom: 1px solid #eee; transition: all 0.3s; align-items: center; }
        .row:last-child { border-bottom: none; }
        .row.scanned { background-color: #fee2e2; border-left: 4px solid #ef4444; } /* Red for Scan */
        .row.hit { background-color: #dcfce7; border-left: 4px solid #22c55e; font-weight: bold; } /* Green for Found */
        .row.index-node { justify-content: space-between; cursor: default; }
        .row.index-hit { background-color: #dbeafe; border-left: 4px solid var(--primary); }
        
        /* Controls */
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: transform 0.1s; }
        button:hover { transform: translateY(-1px); filter: brightness(110%); }
        button.secondary { background: white; border: 2px solid var(--primary); color: var(--primary); }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; box-sizing: border-box; }

        /* Arrows for pointers */
        .pointer-arrow { position: absolute; height: 2px; background: var(--accent); transform-origin: left center; z-index: 10; pointer-events: none; }

        /* Stats & Logs */
        .stats-box { background: #1e293b; color: #a5f3fc; padding: 15px; border-radius: 8px; font-family: monospace; margin-top: 15px; }
        .log-entry { margin: 4px 0; border-bottom: 1px solid #334155; padding-bottom: 2px; }
        
        h2 { border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .badge { font-size: 0.8em; background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; margin-bottom: 40px;">
        <h1>Internals of a Secondary Index</h1>
        <p>Visualize the cost difference between <code>Table Scans</code> and <code>Index Lookups</code>.</p>
    </header>

    <div class="panel" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; align-items: end;">
            <div style="flex: 1;">
                <label><strong>1. Write a Query</strong></label>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px; font-family: monospace; font-size: 1.1em;">
                    SELECT * FROM Users WHERE 
                    <select id="colSelect" style="width: auto;">
                        <option value="department">Department</option>
                        <option value="name">Name</option>
                    </select>
                    = 
                    <input type="text" id="valInput" value="Engineering" style="width: 150px;">
                </div>
            </div>
            <button onclick="runQuery()">Execute Query</button>
            <button class="secondary" onclick="generateData()">Regenerate Data</button>
        </div>
        <div id="indexToggle" style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
            <input type="checkbox" id="useIndex" style="width: auto; transform: scale(1.5);">
            <label for="useIndex"><strong>Create Index on 'Department'</strong> (Simulate <code>CREATE INDEX idx_dept ON Users(department)</code>)</label>
        </div>
    </div>

    <div class="grid">
        
        <div class="panel" id="tablePanel">
            <h2>
                Disk Storage (Heap)
                <span class="badge">Unsorted</span>
            </h2>
            <div style="font-size: 0.85em; color: #64748b; margin-bottom: 10px;">
                Physical rows stored on disk. Order is usually insertion order (or clustered key).
            </div>
            <div id="tableContainer"></div>
        </div>

        <div class="panel" id="indexPanel" style="opacity: 0.5;">
            <h2>
                Secondary Index (B-Tree)
                <span class="badge">Sorted by Dept</span>
            </h2>
            <div style="font-size: 0.85em; color: #64748b; margin-bottom: 10px;">
                A separate data structure. Contains the <strong>Key</strong> (Dept) and a <strong>Pointer</strong> (Row ID) to the Heap.
            </div>
            <div id="indexContainer"></div>
        </div>

    </div>

    <div class="stats-box" id="consoleOutput">
        <div>> System Ready. Load data to begin...</div>
    </div>

    <div class="panel" style="margin-top: 30px; background: #fff7ed; border-color: #fed7aa;">
        <h3 style="color: #c2410c;">üß† Gut Check: Exercise</h3>
        <p id="questionText">Loading question...</p>
        <div id="options" style="display: flex; gap: 10px; margin-top: 10px;"></div>
        <div id="feedback" style="margin-top: 10px; font-weight: bold;"></div>
    </div>

</div>

<script>
    // --- State Management ---
    const DEPARTMENTS = ['Engineering', 'Sales', 'HR', 'Marketing', 'Finance'];
    const NAMES = ['Ashok', 'Siddharth', 'Surya', 'Priya', 'Alice', 'Bob', 'Charlie', 'David'];
    let tableData = [];
    let indexData = []; // Represents (Key, RowID) pairs
    let isIndexActive = false;

    // --- Core Logic ---

    function generateData() {
        tableData = [];
        // Generate 15 random rows
        for(let i=0; i<15; i++) {
            tableData.push({
                id: i, // Row ID (RID)
                name: NAMES[Math.floor(Math.random() * NAMES.length)],
                dept: DEPARTMENTS[Math.floor(Math.random() * DEPARTMENTS.length)],
                salary: Math.floor(Math.random() * 50000) + 50000
            });
        }
        buildIndex();
        render();
        log("Data regenerated. Table is unsorted heap.");
    }

    function buildIndex() {
        // A Secondary Index is essentially a SORTED list of (Key, Pointer)
        indexData = tableData.map(row => ({ key: row.dept, ptr: row.id }));
        // Sort by the indexed column (Department)
        indexData.sort((a, b) => a.key.localeCompare(b.key));
    }

    // --- Visualization & Rendering ---

    function render() {
        const tableContainer = document.getElementById('tableContainer');
        const indexContainer = document.getElementById('indexContainer');
        const indexPanel = document.getElementById('indexPanel');
        const checkbox = document.getElementById('useIndex');

        isIndexActive = checkbox.checked;
        indexPanel.style.opacity = isIndexActive ? "1" : "0.5";

        // Render Table (Heap)
        tableContainer.innerHTML = `
            <div style="display:flex; font-weight:bold; border-bottom:2px solid #ccc; padding:5px;">
                <div style="width:30px">RID</div>
                <div style="flex:1">Name</div>
                <div style="flex:1">Dept</div>
            </div>
        `;
        tableData.forEach(row => {
            const div = document.createElement('div');
            div.className = 'row';
            div.id = `row-${row.id}`;
            div.innerHTML = `
                <div style="width:30px; color:#999;">#${row.id}</div>
                <div style="flex:1">${row.name}</div>
                <div style="flex:1" class="dept-val">${row.dept}</div>
            `;
            tableContainer.appendChild(div);
        });

        // Render Index (only if active)
        indexContainer.innerHTML = '';
        if (isIndexActive) {
            indexContainer.innerHTML = `
                <div style="display:flex; font-weight:bold; border-bottom:2px solid #ccc; padding:5px;">
                    <div style="flex:1">Key (Dept)</div>
                    <div style="width:50px">Ptr</div>
                </div>
            `;
            indexData.forEach((node, idx) => {
                const div = document.createElement('div');
                div.className = 'row index-node';
                div.id = `idx-${idx}`;
                div.innerHTML = `
                    <div style="flex:1">${node.key}</div>
                    <div style="width:50px; font-family:monospace; color:var(--accent);">#${node.ptr}</div>
                `;
                indexContainer.appendChild(div);
            });
        }
    }

    // --- The Engine (Simulation) ---

    async function runQuery() {
        // Reset visuals
        document.querySelectorAll('.row').forEach(r => r.className = 'row'); // Clear highlights
        document.querySelectorAll('.row.index-node').forEach(r => r.classList.add('index-node'));
        
        const col = document.getElementById('colSelect').value;
        const val = document.getElementById('valInput').value;
        const useIdx = document.getElementById('useIndex').checked;

        log(`> Executing: SELECT * FROM Users WHERE ${col} = '${val}'`);

        if (useIdx && col === 'department') {
            await runIndexSeek(val);
        } else {
            if (useIdx && col !== 'department') {
                log(`WARN: Index exists on 'department', but query is on '${col}'. Index cannot be used!`);
            }
            await runTableScan(col, val);
        }
    }

    async function runTableScan(col, val) {
        log("Strategy: FULL TABLE SCAN (O(N))");
        let ops = 0;
        let matches = 0;

        for (const row of tableData) {
            const el = document.getElementById(`row-${row.id}`);
            
            // Visualize "Reading from Disk"
            el.classList.add('scanned');
            await sleep(200); // Artificial delay for intuition
            ops++;

            if (row[col] === val) {
                el.classList.remove('scanned');
                el.classList.add('hit');
                matches++;
                log(`  - Row #${row.id}: MATCH found.`);
            } else {
                log(`  - Row #${row.id}: Checked, no match.`);
            }
        }
        log(`RESULT: Found ${matches} records. Cost: ${ops} disk reads.`);
    }

    async function runIndexSeek(targetVal) {
        log("Strategy: SECONDARY INDEX SEEK (O(log N))");
        let ops = 0;
        let matches = 0;

        // 1. Traverse Index (Binary Search visualization simplified to linear scan of sorted list for demo)
        // In reality, this is O(log N). We will visually scan the index to find the range.
        
        let startIdx = -1;
        let endIdx = -1;

        // Visual: Scan Index to find range
        for (let i = 0; i < indexData.length; i++) {
            const node = indexData[i];
            const el = document.getElementById(`idx-${i}`);
            
            // Optimization: Since it's sorted, once we pass the value, we stop.
            if (node.key > targetVal) break; 

            if (node.key === targetVal) {
                el.classList.add('index-hit');
                ops++; // Reading index page
                
                // 2. The Key Lookup (Indirection)
                log(`  - Index Hit: '${node.key}' points to Row #${node.ptr}`);
                
                // Visualize the "Jump" to the heap
                const tableRow = document.getElementById(`row-${node.ptr}`);
                tableRow.classList.add('hit');
                ops++; // Reading heap page (random I/O)
                
                matches++;
                await sleep(300);
            }
        }
        
        log(`RESULT: Found ${matches} records. Total Ops: ${ops} (Index Nodes + Heap Lookups).`);
        if (matches > 5) {
            log("NOTE: Because many rows matched, the random I/O to fetch rows might actually be slower than a sequential scan!");
        }
    }

    // --- Utilities ---
    function log(msg) {
        const consoleEl = document.getElementById('consoleOutput');
        const line = document.createElement('div');
        line.className = 'log-entry';
        line.innerText = msg;
        consoleEl.insertBefore(line, consoleEl.firstChild);
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // --- Exercises Logic ---
    const questions = [
        {
            q: "We have an index on 'Department'. We run: `SELECT * FROM Users WHERE Name = 'Ashok'`. Will the index be used?",
            opts: ["Yes", "No"],
            ans: 1,
            expl: "Correct. The index is sorted by Department, not Name. The database must scan the table."
        },
        {
            q: "If we select `WHERE Department = 'Sales'`, and 'Sales' appears in 90% of the rows, is the index faster?",
            opts: ["Yes, Index is always faster", "No, Scan might be faster"],
            ans: 1,
            expl: "Correct! If you have to fetch 90% of the rows anyway, hopping back and forth between Index and Table (Random I/O) is slower than just reading the Table sequentially (Sequential I/O)."
        }
    ];

    function loadExercise(idx) {
        const q = questions[idx];
        document.getElementById('questionText').innerText = `Question ${idx+1}: ${q.q}`;
        const optsDiv = document.getElementById('options');
        optsDiv.innerHTML = '';
        q.opts.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'secondary';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(idx, i);
            optsDiv.appendChild(btn);
        });
    }

    function checkAnswer(qIdx, optIdx) {
        const q = questions[qIdx];
        const feedback = document.getElementById('feedback');
        if (optIdx === q.ans) {
            feedback.style.color = 'green';
            feedback.innerText = "‚úÖ " + q.expl;
            if (qIdx < questions.length -1) setTimeout(() => loadExercise(qIdx + 1), 3000);
        } else {
            feedback.style.color = 'red';
            feedback.innerText = "‚ùå Think about how the data is sorted...";
        }
    }

    // Init
    generateData();
    loadExercise(0);

</script>
</body>
</html>
